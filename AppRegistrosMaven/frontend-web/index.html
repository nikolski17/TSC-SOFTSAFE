<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Iniciar Sesión - TSC SOFTSAFE</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; transition: background-image 1s ease-in-out; }
        .glass-container {
            background: rgba(255, 255, 255, 0.6);
            -webkit-backdrop-filter: blur(12px) saturate(180%);
            backdrop-filter: blur(12px) saturate(180%);
            border: 1px solid rgba(209, 213, 219, 0.3);
        }
        .loader {
            border: 4px solid #f3f3f3; border-top: 4px solid #3498db;
            border-radius: 50%; width: 24px; height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .fade-out { transition: opacity 0.5s ease-out; opacity: 0; visibility: hidden; }
        .fade-in { transition: opacity 0.5s ease-in; opacity: 1; visibility: visible; }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen">

    <div id="main-content">
        <!-- Contenedor del Formulario de Login (Inicialmente visible) -->
        <div id="login-container" class="w-full max-w-md rounded-2xl shadow-lg p-8 m-4 glass-container">
            <div class="text-center mb-8">
                <img src="https://placehold.co/100x100/E2E8F0/4A5568?text=TSC&font=inter" alt="Logo TSC" class="w-24 h-24 rounded-full mx-auto mb-4">
                <h1 class="text-2xl font-bold text-gray-900">Bienvenido a TSC SOFTSAFE</h1>
                <p class="text-gray-600 mt-2">Ingresa tus credenciales para continuar.</p>
            </div>
            <form id="login-form">
                <div class="mb-4">
                    <label for="centro" class="block text-gray-700 text-sm font-bold mb-2">Centro / Cliente:</label>
                    <select id="centro" name="centro" class="shadow-sm appearance-none border border-gray-300 bg-white bg-opacity-50 rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"></select>
                </div>
                <div class="mb-4">
                    <label for="usuario" class="block text-gray-700 text-sm font-bold mb-2">Usuario:</label>
                    <input type="text" id="usuario" name="usuario" placeholder="ej: admin" class="shadow-sm appearance-none border border-gray-300 bg-white bg-opacity-50 rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                <div class="mb-6">
                    <label for="password" class="block text-gray-700 text-sm font-bold mb-2">Contraseña:</label>
                    <input type="password" id="password" name="password" placeholder="••••••••" class="shadow-sm appearance-none border border-gray-300 bg-white bg-opacity-50 rounded-lg w-full py-3 px-4 text-gray-700 mb-3 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                <div class="flex items-center justify-between">
                    <button id="login-button" type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg focus:outline-none focus:shadow-outline transition duration-300 flex items-center justify-center">
                        <span class="btn-text">Ingresar</span>
                        <div class="loader hidden ml-2"></div>
                    </button>
                </div>
            </form>
            <p class="text-center text-gray-500 text-xs mt-8">&copy;2025 TSC. Todos los derechos reservados.</p>
        </div>

        <!-- Contenedor del Formulario de Registro (Inicialmente oculto) -->
        <div id="registro-container" class="w-full max-w-3xl rounded-2xl shadow-lg p-8 m-4 glass-container hidden">
            <!-- El contenido se generará dinámicamente -->
        </div>
    </div>

    <script>
        // --- CONFIGURACIÓN ---
        const backendUrl = 'http://localhost:8080';

        // --- MANEJO DE ESTADO ---
        let clienteActualInfo = null;
        let camposDelCliente = [];

        // --- ELEMENTOS DEL DOM ---
        const loginContainer = document.getElementById('login-container');
        const registroContainer = document.getElementById('registro-container');
        const loginForm = document.getElementById('login-form');
        const comboCentro = document.getElementById('centro');
        const loginButton = document.getElementById('login-button');
        const loginButtonText = loginButton.querySelector('.btn-text');
        const loginButtonLoader = loginButton.querySelector('.loader');

        // --- FUNCIONES DE LA API ---
        async function fetchClientConfig() {
            try {
                const response = await fetch(`${backendUrl}/api/config/clientes`);
                const data = await response.json();
                comboCentro.innerHTML = ''; // Limpiar opciones
                data.forEach(cliente => {
                    const option = document.createElement('option');
                    option.value = cliente;
                    option.textContent = cliente;
                    comboCentro.appendChild(option);
                });
            } catch (error) {
                console.error("Error cargando configuración de clientes:", error);
                alert("No se pudo cargar la lista de clientes desde el servidor.");
            }
        }

        async function handleLogin(event) {
            event.preventDefault();
            
            loginButtonText.textContent = 'Verificando...';
            loginButtonLoader.classList.remove('hidden');
            loginButton.disabled = true;

            const formData = new FormData(loginForm);
            const data = Object.fromEntries(formData.entries());

            try {
                const response = await fetch(`${backendUrl}/api/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ centro: data.centro, usuario: data.usuario, contrasena: data.password })
                });
                const result = await response.json();

                if (result.status === 'success') {
                    clienteActualInfo = result.clienteInfo;
                    camposDelCliente = result.campos;
                    mostrarFormularioRegistro();
                } else {
                    alert('Error: ' + result.message);
                }
            } catch (error) {
                console.error('Error de conexión:', error);
                alert('No se pudo conectar con el servidor. Asegúrate de que el backend Java esté corriendo.');
            } finally {
                loginButtonText.textContent = 'Ingresar';
                loginButtonLoader.classList.add('hidden');
                loginButton.disabled = false;
            }
        }
        
        async function handleGuardarRegistro(event) {
            event.preventDefault();
            const guardarButton = document.getElementById('guardar-button');
            guardarButton.disabled = true;
            guardarButton.textContent = 'Guardando...';

            const formData = new FormData(event.target);
            const datosFormulario = Object.fromEntries(formData.entries());

            try {
                 const response = await fetch(`${backendUrl}/api/registrar`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ idHojaDatos: clienteActualInfo.idDatos, datosFormulario })
                });
                const result = await response.json();

                if (result.status === 'success') {
                    alert(result.message);
                    event.target.reset(); 
                } else {
                    alert('Error al guardar: ' + result.message);
                }
            } catch(error) {
                console.error('Error al guardar:', error);
                alert('No se pudo guardar el registro.');
            } finally {
                guardarButton.disabled = false;
                guardarButton.textContent = 'Guardar Registro';
            }
        }

        // --- FUNCIONES DE LA UI ---
        function mostrarFormularioRegistro() {
            loginContainer.classList.add('fade-out');
            
            setTimeout(() => {
                loginContainer.classList.add('hidden');

                const registroHtml = `
                    <div class="text-center mb-8">
                        <h1 class="text-2xl font-bold text-gray-900">Registro de Leads para ${clienteActualInfo.nombreCentro}</h1>
                        <p class="text-gray-600 mt-2">Completa la información del nuevo lead.</p>
                    </div>
                    <form id="registro-form" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        ${camposDelCliente.map(campo => `
                            <div class="flex flex-col">
                                <label class="block text-gray-700 text-sm font-bold mb-2">${campo.nombre}:</label>
                                ${campo.tipo.toLowerCase() === 'texto' 
                                    ? `<input type="text" name="${campo.nombre}" class="shadow-sm appearance-none border border-gray-300 bg-white bg-opacity-50 rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500">`
                                    : `<select name="${campo.nombre}" class="shadow-sm appearance-none border border-gray-300 bg-white bg-opacity-50 rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        ${campo.opciones.map(opcion => `<option>${opcion}</option>`).join('')}
                                      </select>`
                                }
                            </div>
                        `).join('')}
                    </form>
                    <div class="flex items-center justify-center mt-8 gap-4">
                        <button id="guardar-button" type="submit" form="registro-form" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg">Guardar Registro</button>
                        <button id="buscar-button" class="w-full bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-4 rounded-lg">Buscar y Actualizar</button>
                        <button id="logout-button" class="w-full bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-4 rounded-lg">Cerrar Sesión</button>
                    </div>
                `;
                registroContainer.innerHTML = registroHtml;
                registroContainer.classList.remove('hidden');
                registroContainer.classList.add('fade-in');

                document.getElementById('registro-form').addEventListener('submit', handleGuardarRegistro);
                document.getElementById('logout-button').addEventListener('click', handleLogout);
            }, 500);
        }

        function handleLogout() {
            registroContainer.classList.remove('fade-in');
            registroContainer.classList.add('fade-out');
            
            setTimeout(() => {
                registroContainer.classList.add('hidden');
                loginForm.reset();
                loginContainer.classList.remove('hidden');
                loginContainer.classList.remove('fade-out');
            }, 500);
        }
        
        // --- Lógica de Fondo Dinámico ---
        const pastelGradients = [
            'linear-gradient(to top right, #B3EBF2, #D3D3FF)', 'linear-gradient(to top right, #EDE8D0, #F2D1B3)',
            'linear-gradient(to top right, #C1F2B0, #B3E0F2)', 'linear-gradient(to top right, #FFD1DC, #FFDDA1)'
        ];
        function setRandomBackground() {
            document.body.style.backgroundImage = pastelGradients[Math.floor(Math.random() * pastelGradients.length)];
        }

        // --- INICIAR LA APLICACIÓN ---
        document.addEventListener('DOMContentLoaded', () => {
            setRandomBackground();
            fetchClientConfig(); // Cargar clientes al inicio
            loginForm.addEventListener('submit', handleLogin);
        });
    </script>
</body>
</html>

